---
title: "DROPLET analysis"
output: html_document
---

```{r}

install.packages(c("useful", "ontologyIndex", "tidyverse"))

if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("DESeq2", version = "3.8")


if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("MAST", version = "3.8")

```

```{r include=FALSE}

library(here)
library(Seurat)
source(here("00_data_ingest", "02_tissue_analysis_rmd", "boilerplate.R"))

tissues_of_interest = c("Heart_and_Aorta", "Lung", "Kidney", "Bladder", "Liver")

processSeurat = function(dropletTiss, scale){
  dropletTiss <- NormalizeData(object = dropletTiss, scale.factor = scale)
  dropletTiss <- ScaleData(object = dropletTiss)
  
  dropletTiss <- FindVariableFeatures(object = dropletTiss, selection.method = 'mean.var.plot', mean.cutoff = c(0.0125, 3), dispersion.cutoff = c(0.5, Inf))

  #dropletTiss <- FindVariableGenes(object = dropletTiss, do.plot = TRUE, x.high.cutoff = Inf, y.cutoff = 0.5)
  dropletTiss <- RunPCA(object = dropletTiss, do.print = FALSE)
  
  dropletTiss <- FindNeighbors(object = dropletTiss)
  #dropletTiss <- ProjectPCA(object = dropletTiss, do.print = FALSE)
  
  dropletTiss = ProjectDim(dropletTiss, reduction="pca")
}

#aorta, lung, colon (large intestine), kidney, bladder and liver

```

## R Markdown

Here we are now loading the seurat objects

```{r}

all_tissues = c()

for (tissue_if_interest in tissues_of_interest){
  
    filename = here('00_data_ingest', '04_tissue_robj_generated', paste0("droplet_", tissue_if_interest, "_seurat_tiss.Robj"))
    print(filename)
    load(file=filename)
    tissue_1 = UpdateSeuratObject(tiss)
  
    all_tissues = append(all_tissues, tissue_1)
}


```

## Including Plots

You can also embed plots, for example:

```{r results='asis'}

for (tissue_obj in all_tissues){
  
    plot = DimPlot(object = tissue_obj, reduction = "tsne", group.by='cell_ontology_class')
    print(plot)
}


```


```{r}

dropletTiss = merge(x=all_tissues[[1]], y=all_tissues[2:length(all_tissues)], add.cell.ids=tissues_of_interest)

dropletTiss <- processSeurat(dropletTiss, 1e4)

n.pcs = 20
res.used <- 3

dropletTiss <- FindClusters(object = dropletTiss, reduction.type = "pca", dims.use = 1:n.pcs, resolution = res.used, print.output = 0, save.SNN = TRUE)
dropletTiss <- RunTSNE(object = dropletTiss, dims.use = 1:n.pcs, seed.use = 10, perplexity=30)

DimPlot(object = dropletTiss, reduction = "tsne", group.by='cell_ontology_class')

all_tissues = NULL;

```



```{r}

setCellIdent <- function (object, idp1, idp2) 
{
	
	cells.use <- rownames(x = object@meta.data)
	ident.use <- paste(object@meta.data[, idp1], object@meta.data[, idp2], sep=".")
	Idents(object = object, cells.use = cells.use)= ident.use
	
	return(object)
}


```


```{r}
dropletTiss <- setCellIdent(object = dropletTiss, idp1="tissue", idp2= "cell_ontology_class")

table(Idents(dropletTiss))

```


Eventually we can now perform DE analysis:


```{r}

tissues_of_interest = c("Heart_and_Aorta", "Lung", "Kidney", "Bladder", "Liver")

dropletAortaEndo = c("Heart_and_Aorta.endothelial cell")
dropletAortaEpi = c("Heart_and_Aorta.endocardial cell")

dropletLungEndo = c("Lung.lung endothelial cell")
dropletLungEpi = c("Lung.stromal cell")

dropletKidneyEndo = c("Kidney.kidney capillary endothelial cell")
dropletKidneyEpi = c("Kidney.kidney collecting duct epithelial cell",
                     "Kidney.kidney proximal straight tubule epithelial cell",
                     "Kidney.kidney loop of Henle ascending limb epithelial cell"
                     )

dropletBladderEndo = c("Bladder.bladder urothelial cell", "Bladder.endothelial cell")
dropletBladderEpi = c("Bladder.bladder cell")

dropletLiverEndo = c("Liver.endothelial cell of hepatic sinusoid")
dropletLiverEpi = c("Liver.duct epithelial cell", "Liver.hepatocyte")


# newer version

dropletAortaEpi = c()
dropletLiverEpi = c("Liver.duct epithelial cell")
dropletLungEpi = c()
dropletKidneyEpi = c()
dropletBladderEpi = c()

dropletAortaEndo = c("Heart_and_Aorta.endothelial cell")
dropletLiverEndo = c("Liver.endothelial cell of hepatic sinusoid")
dropletLungEndo = c("Lung.lung endothelial cell")
dropletKidneyEndo = c("Kidney.kidney capillary endothelial cell")
dropletBladderEndo = c("Bladder.endothelial cell")


dropletAortaCir = c()
dropletLiverCir = c("Liver.leukocyte")
dropletLungCir = c("Lung.myeloid cell", "Lung.B cell", "Lung.natural killer cell", "Lung.T cell", "Lung.non-classical monocyte", "Lung.leukocyte", "Lung.classical monocyte")
dropletKidneyCir = c("Kidney.leukocyte")
dropletBladderCir = c("Bladder.leukocyte")


dropletAortaCells = c(dropletAortaEndo,dropletAortaEpi, dropletAortaCir)
dropletLungCells = c(dropletLungEndo,dropletLungEpi, dropletLungCir)
dropletKidneyCells = c(dropletKidneyEndo,dropletKidneyEpi, dropletKidneyCir)
dropletBladderCells = c(dropletBladderEndo,dropletBladderEpi, dropletBladderCir)
dropletLiverCells = c(dropletLiverEndo, dropletLiverEpi, dropletLiverCir)


dropletAllAorta = unique(grep(pattern="Heart_and_Aorta", x=Idents(dropletTiss), value = TRUE))
dropletAllAorta = setdiff(dropletAllAorta, dropletAortaCells)

dropletAllLung = unique(grep(pattern="Lung", x=Idents(dropletTiss), value = TRUE))
dropletAllLung = setdiff(dropletAllLung, dropletLungCells)

dropletAllKidney = unique(grep(pattern="Kidney", x=Idents(dropletTiss), value = TRUE))
dropletAllKidney = setdiff(dropletAllKidney, dropletKidneyCells)

dropletAllBladder = unique(grep(pattern="Bladder", x=Idents(dropletTiss), value = TRUE))
dropletAllBladder = setdiff(dropletAllBladder, dropletBladderCells)

dropletAllLiver = unique(grep(pattern="Liver", x=Idents(dropletTiss), value = TRUE))
dropletAllLiver = setdiff(dropletAllLiver, dropletLiverCells)

```

```{r}


print(dropletAortaCells)
print(dropletLungCells)
print(dropletKidneyCells)
print(dropletBladderCells)
print(dropletLiverCells)

print(dropletAllAorta)
print(dropletAllLung)
print(dropletAllKidney)
print(dropletAllBladder)
print(dropletAllLiver)


```

We should prepare our functions again ....

```{r}

makeAnalysis <- function( tissues1, tissues2)
{
  
    if (is.null(tissues1)|| is.null(tissues2))
    {
      print("makeAnalysis failed due to null tissue")
      return(NULL)
    }
  
    if (length(tissues1) == 0 || length(tissues2) == 0)
    {
      print("makeAnalysis failed due to 0 length tissue")
      return(NULL)
    }
  
    newMarkers = FindMarkers(dropletTiss, ident.1=tissues1, ident.2=tissues2,only.pos=TRUE, test.use="MAST")
    return(newMarkers)
}

```


Now we can run the analysis against each other ...

# Analysis: Endothelial Cells against each other


## Aorta vs Lung

```{r}

aorta_lung_markers_droplet = makeAnalysis(dropletAortaEndo, dropletLungEndo)

write.table(aorta_lung_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("aorta_lung_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')
```

## Aorta vs Kidney
```{r}

aorta_kidney_markers_droplet = makeAnalysis(dropletAortaEndo, dropletKidneyEndo)

write.table(aorta_kidney_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("aorta_kidney_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')
```

## Aorta vs Bladder

```{r}

aorta_bladder_markers_droplet = makeAnalysis(dropletAortaEndo, dropletBladderEndo)

write.table(aorta_bladder_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("aorta_bladder_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')
```

## Aorta vs Liver

```{r}

aorta_liver_markers_droplet = makeAnalysis(dropletAortaEndo, dropletLiverEndo)

write.table(aorta_liver_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("aorta_liver_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')
```

## Lung vs Kidney

```{r}

lung_kidney_markers_droplet = makeAnalysis(dropletLungEndo, dropletKidneyEndo)

write.table(lung_kidney_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("lung_kidney_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')
```

## Lung vs Bladder

```{r}

lung_bladder_markers_droplet = makeAnalysis(dropletLungEndo, dropletBladderEndo)

write.table(lung_bladder_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("lung_bladder_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')
```

## Lung vs Liver

```{r}

lung_liver_markers_droplet = makeAnalysis(dropletLungEndo, dropletLiverEndo)

write.table(lung_liver_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("lung_liver_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')
```


## Kidney vs Bladder
```{r}

kidney_bladder_markers_droplet = makeAnalysis(dropletKidneyEndo, dropletBladderEndo)

write.table(kidney_bladder_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("kidney_bladder_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')
```

## Kidney vs Liver

```{r}

kidney_liver_markers_droplet = makeAnalysis(dropletKidneyEndo, dropletLiverEndo)

write.table(kidney_liver_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("kidney_liver_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')
```

## Bladder vs Liver
```{r}

bladder_liver_markers_droplet = makeAnalysis(dropletBladderEndo, dropletLiverEndo)

write.table(bladder_liver_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("bladder_liver_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')
```

# Analysis same organ, endo vs epi

## Aorta Endo vs Aorta Epi
```{r}

aorta_endopi_markers_droplet = makeAnalysis(dropletAortaEndo, dropletAortaEpi)

write.table(aorta_endopi_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("aorta_endopi_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')

```

## Bladder Endo vs Bladder Epi
```{r}

bladder_endopi_markers_droplet = makeAnalysis(dropletBladderEndo, dropletBladderEpi)

write.table(bladder_endopi_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("bladder_endopi_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')

```

## Kidney Endo vs Kidney Epi
```{r}

kidney_endopi_markers_droplet = makeAnalysis(dropletKidneyEndo, dropletKidneyEpi)

write.table(kidney_endopi_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("kidney_endopi_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')

```

## Liver Endo vs Liver Epi
```{r}

liver_endopi_markers_droplet = makeAnalysis(dropletLiverEndo, dropletLiverEpi)

write.table(liver_endopi_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("liver_endopi_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')

```

## Lung Endo vs Lung Epi
```{r}

lung_endopi_markers_droplet = makeAnalysis(dropletLungEndo, dropletLungEpi)

write.table(lung_endopi_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("lung_endopi_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')

```

# Analysis same organ, endo vs rest+epi

## Aorta Endo

```{r}

aorta_endo_rest_markers_droplet = makeAnalysis(dropletAortaEndo, unique(c(dropletAllAorta, dropletAortaEpi)))

write.table(aorta_endo_rest_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("aorta_endo_rest_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')

```
## Bladder Endo

```{r}

bladder_endo_rest_markers_droplet = makeAnalysis(dropletBladderEndo, unique(c(dropletAllBladder, dropletBladderEpi)))

write.table(bladder_endo_rest_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("bladder_endo_rest_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')

```

## Kidney Endo

```{r}

kidney_endo_rest_markers_droplet = makeAnalysis(dropletKidneyEndo, unique(c(dropletAllKidney, dropletKidneyEpi)))

write.table(kidney_endo_rest_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("kidney_endo_rest_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')
```

## Liver Endo

```{r}

liver_endo_rest_markers_droplet = makeAnalysis(dropletLiverEndo, unique(c(dropletAllLiver, dropletLiverEpi)))

write.table(liver_endo_rest_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("liver_endo_rest_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')

```

## Lung Endo

```{r}

lung_endo_rest_markers_droplet = makeAnalysis(dropletLungEndo, unique(c(dropletAllLung, dropletLungEpi)))

write.table(lung_endo_rest_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("lung_endo_rest_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')

```


# here we can do new analyses.

##-> endothelial X vs all other (epi, endo, circ)
## these markers are then specific for this endothelial cell!

### Aorta

```{r}

makeNewAnalysis = function(targetCells, sourceCells, tissueName, prefix) {
    if (is.null(targetCells)|| is.null(sourceCells))
    {
      print("makeAnalysis failed due to null tissue")
      return(NULL)
    }
  
    if (length(targetCells) == 0 || length(sourceCells) == 0)
    {
      print("makeAnalysis failed due to 0 length tissue")
      return(NULL)
    }
  
  
  allComparisons = c()
  
  for (targetCell in targetCells)
  {
    
    targetComparisons = c()
  
    for (sourceCell in sourceCells)
    {
      
      newMarkers = FindMarkers(dropletTiss, ident.1=c(targetCell), ident.2=c(sourceCell),only.pos=FALSE, test.use="MAST")
      
      
      
      outfname = gsub(" ", "_", paste(prefix, paste(tissueName, targetCell, sourceCell, sep = "___"), ".tsv", sep=""))
      print(outfname)
      
      write.table(newMarkers, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis_excl", outfname) ,quote=FALSE, sep='\t')
      
      targetComparisons = append(targetComparisons, list(newMarkers))
      
    }

    allComparisons = append(allComparisons, list(targetComparisons))
    
  }
  
  return(allComparisons)
}

```


```{r}

excl_endo_kidney_markers_droplet = makeNewAnalysis(dropletKidneyEndo, c(dropletKidneyCir, dropletKidneyEpi, dropletAllKidney), "kidney", "excl_")
excl_endo_lung_markers_droplet = makeNewAnalysis(dropletLungEndo, c(dropletLungCir, dropletLungEpi, dropletAllLung), "lung", "excl_")
excl_endo_lung_markers_droplet = makeNewAnalysis(dropletAortaEndo, c(dropletAortaCir, dropletAortaEpi, dropletAllAorta), "aorta", "excl_")
excl_endo_lung_markers_droplet = makeNewAnalysis(dropletLungEndo, c(dropletLungCir, dropletLungEpi, dropletAllLung), "lung", "excl_")
excl_endo_lung_markers_droplet = makeNewAnalysis(dropletLungEndo, c(dropletLungCir, dropletLungEpi, dropletAllLung), "lung", "excl_")

write.table(excl_endo_aorta_markers_droplet, file = here("00_data_ingest", "sanne_analysis", "droplet_analysis", paste("excl_endo_aorta_markers_droplet",".tsv", sep="")) ,quote=FALSE, sep='\t')

VlnPlot(object = dropletTiss, features = c(rownames(head(x = excl_endo_aorta_markers_droplet, n=2)), "Mgll"), ncol=3, idents=unique(c(dropletAortaEndo, dropletLungEndo)), slot = 'counts', log = TRUE, same.y.lims =FALSE)

```


```{r}


for (targetCellData in excl_endo_aorta_markers_droplet)
{
  

  
}



```
